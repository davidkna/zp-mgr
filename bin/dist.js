"use strict";function n(n){return n&&n.__esModule?n:{default:n}}function e(n){return function(){var e=n.apply(this,arguments);return new Promise(function(n,t){function i(r,u){try{var o=e[r](u),a=o.value}catch(n){return void t(n)}return o.done?void n(a):Promise.resolve(a).then(function(n){return i("next",n)},function(n){return i("throw",n)})}return i("next")})}}var t=require("path"),i=n(t),r=require("execa"),u=n(r),o=require("findup-sync"),a=n(o),l=require("fs-jetpack"),c=n(l),f=require("lodash.includes"),s=n(f),d=require("listr"),h=n(d),g=require("mkdirp"),p=n(g),m=require("xdg-basedir"),w=n(m);const q=i.default.join(w.default.data,"zsh_plugins");(0,p.default)(q);const v=require(i.default.join(w.default.config,"zsh-plugin-manager","config.js")),y=new Array(v.length),j=new Array(v.length);class z{constructor(n){this.name=n,this.uniqueName=n.split("/")[1],this.clonePath=i.default.join(q,this.uniqueName)}download(){var n=this;return e(function*(){const{name,clonePath}=n;switch(c.default.exists(i.default.join(clonePath,".git"))){case!1:c.default.exists(clonePath)&&c.default.remove(clonePath),yield(0,u.default)("git",["clone","--recursive","--",`https://github.com/${name}.git`,clonePath]);break;case"dir":yield(0,u.default)("git",["fetch","--all"],{cwd:clonePath}),yield(0,u.default)("git",["reset","--hard","origin/master","--"],{cwd:clonePath});break;default:throw new Error("Invalid clone target!")}})()}getFpath(){return this.clonePath}getSourceFile(){const n=this.name.split("/")[1],e=[`${n}?(.plugin).?(z)sh`,"*.plugin.zsh","init.zsh","*.zsh","*.sh"];return(0,a.default)(e,{cwd:this.clonePath,nocase:!0})}}const x=new h.default([{title:"Downloading plugins…",task(){return new h.default(v.map((n,t)=>{return{title:`Downloading ${n}...`,task(){return e(function*(){"string"==typeof v[t]&&(v[t]=new z(n));const e=v[t];yield e.download(),y[t]=e.getSourceFile(),j[t]=e.getFpath()})()}}}),{concurrent:!0})}},{title:`Writing to ${i.default.join(q,"plugins.zsh")}…`,task(){return e(function*(){const n=i.default.join(q,"plugins.zsh"),e=y.filter(function(n){return n}).map(function(n){return`source ${n}`}).join("\n"),t=j.filter(function(n){return n}).map(function(n){return`fpath+=${n}`}).join("\n");yield c.default.writeAsync(n,`${e}
${t}`)})()}},{title:"Cleaning up old plugins…",task(){return e(function*(){const n=[...v.map(function(n){return n.uniqueName}),"plugins.zsh"],e=c.default.list(q);e&&e.filter(function(e){return!(0,s.default)(n,e)}).forEach(function(n){return c.default.remove(i.default.join(q,n))})})()}}]);x.run();
