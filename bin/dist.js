"use strict";function t(t){return t&&t.__esModule?t:{default:t}}function e(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var n=require("crypto"),i=t(n),r=require("path"),a=t(r),u=require("execa"),s=t(u),o=require("findup-sync"),c=t(o),l=require("fs-jetpack"),f=t(l),d=require("lodash.includes"),h=t(d),g=require("listr"),p=t(g),w=require("mkdirp"),m=t(w),y=require("xdg-basedir"),j=t(y);const q=a.default.join(j.default.data,"zsh_plugins");(0,m.default)(q);const k=require(a.default.join(j.default.config,"zsh-plugin-manager","config.js")),z=new Array(k.length),A=new Array(k.length);class v{constructor(t){this.name=t;const e=i.default.createHash("sha1");e.update(t),this.hash=e.digest("hex"),this.clonePath=a.default.join(q,this.hash)}download(){const t=this.name,e=this.clonePath;switch(f.default.exists(a.default.join(e,".git"))){case!1:f.default.exists(e)&&f.default.remove(e),s.default.sync("git",["clone","--recursive","--",`https://github.com/${t}.git`,e]);break;case"dir":s.default.sync("git",["fetch","--all"],{cwd:e}),s.default.sync("git",["reset","--hard","origin/master","--"],{cwd:e});break;default:throw new Error("Invalid clone target!")}}getFpath(){return this.clonePath}getSourceFile(){const t=this.name.split("/")[1],e=[`${t}?(.plugin).?(z)sh`,"*.plugin.zsh","init.zsh","*.zsh","*.sh"];return(0,c.default)(e,{cwd:this.clonePath,nocase:!0})}}const x=new p.default([{title:"Downloading plugins…",task:function(){return new p.default(k.map(((t,e)=>{return{title:`Downloading ${t}...`,task:function(){"string"==typeof k[e]&&(k[e]=new v(t));const n=k[e];n.download(),z[e]=n.getSourceFile(),A[e]=n.getFpath()}}})),{concurrent:!0})}},{title:`Writing to ${a.default.join(q,"plugins.zsh")}…`,task:function(){const t=a.default.join(q,"plugins.zsh"),e=z.filter((t=>t)).map((t=>`source ${t}`)).join("\n"),n=A.filter((t=>t)).map((t=>`fpath+=${t}`)).join("\n");return f.default.writeAsync(t,`${e}
${n}`)}},{title:"Cleaning up old plugins…",task:function(){const t=[].concat(e(k.map((t=>t.hash))),["plugins.zsh"]),n=f.default.list(q);n&&n.filter((e=>!(0,h.default)(t,e))).forEach((t=>f.default.remove(a.default.join(q,t))))}}]);x.run().catch((t=>{console.error(t),process.exit(1)}));
