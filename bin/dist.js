"use strict";function t(t){return t&&t.__esModule?t:{default:t}}function e(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var n=require("crypto"),i=t(n),r=require("path"),u=t(r),a=require("execa"),s=t(a),o=require("findup-sync"),l=t(o),c=require("fs-jetpack"),f=t(c),d=require("lodash.includes"),h=t(d),g=require("listr"),p=t(g),w=require("mkdirp"),m=t(w),j=require("xdg-basedir"),y=t(j);const q=u.default.join(y.default.data,"zsh_plugins");(0,m.default)(q);const z=require(u.default.join(y.default.config,"zsh-plugin-manager","config.js")),A=new Array(z.length),k=new Array(z.length);class v{constructor(t){this.name=t;const e=i.default.createHash("sha1");e.update(t),this.hash=e.digest("hex"),this.clonePath=u.default.join(q,this.hash)}download(){const t=this.name,e=this.clonePath;switch(f.default.exists(u.default.join(e,".git"))){case!1:return f.default.exists(e)&&f.default.remove(e),(0,s.default)("git",["clone","--recursive","--",`https://github.com/${t}.git`,e]);case"dir":return s.default.sync("git",["fetch","--all"],{cwd:e}),(0,s.default)("git",["reset","--hard","origin/master","--"],{cwd:e});default:throw new Error("Invalid clone target!")}}getFpath(){return this.clonePath}getSourceFile(){const t=this.name.split("/")[1],e=[`${t}?(.plugin).?(z)sh`,"*.plugin.zsh","init.zsh","*.zsh","*.sh"];return(0,l.default)(e,{cwd:this.clonePath,nocase:!0})}}const x=new p.default([{title:"Downloading plugins…",task:function(){return new p.default(z.map(((t,e)=>{return{title:`Downloading ${t}...`,task:function(){"string"==typeof z[e]&&(z[e]=new v(t));const n=z[e];n.download(),A[e]=n.getSourceFile(),k[e]=n.getFpath()}}})),{concurrent:!0})}},{title:`Writing to ${u.default.join(q,"plugins.zsh")}…`,task:function(){const t=u.default.join(q,"plugins.zsh"),e=A.filter((t=>t)).map((t=>`source ${t}`)).join("\n"),n=k.filter((t=>t)).map((t=>`fpath+=${t}`)).join("\n");return f.default.writeAsync(t,`${e}
${n}`)}},{title:"Cleaning up old plugins…",task:function(){const t=[].concat(e(z.map((t=>t.hash))),["plugins.zsh"]),n=f.default.list(q);n&&n.filter((e=>!(0,h.default)(t,e))).forEach((t=>f.default.remove(u.default.join(q,t))))}}]);x.run().catch((t=>{console.error(t),process.exit(1)}));
