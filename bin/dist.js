"use strict";function t(t){return t&&t.__esModule?t:{default:t}}function n(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)}function e(t){return function(){var n=t.apply(this,arguments);return new Promise(function(t,e){function r(i,u){try{var a=n[i](u),o=a.value}catch(t){return void e(t)}return a.done?void t(o):Promise.resolve(o).then(function(t){return r("next",t)},function(t){return r("throw",t)})}return r("next")})}}var r=require("crypto"),i=t(r),u=require("path"),a=t(u),o=require("execa"),l=t(o),s=require("findup-sync"),c=t(s),f=require("fs-jetpack"),d=t(f),h=require("lodash.includes"),g=t(h),p=require("listr"),y=t(p),w=require("mkdirp"),m=t(w),v=require("xdg-basedir"),j=t(v);const q=a.default.join(j.default.data,"zsh_plugins");(0,m.default)(q);const k=require(a.default.join(j.default.config,"zsh-plugin-manager","config.js")),z=new Array(k.length),x=new Array(k.length);class A{constructor(t){this.name=t;const n=i.default.createHash("sha1");n.update(t),this.hash=n.digest("hex"),this.clonePath=a.default.join(q,this.hash)}download(){var t=this;return e(function*(){const n=t.name,e=t.clonePath;switch(d.default.exists(a.default.join(e,".git"))){case!1:d.default.exists(e)&&d.default.remove(e),yield(0,l.default)("git",["clone","--recursive","--",`https://github.com/${n}.git`,e]);break;case"dir":yield(0,l.default)("git",["fetch","--all"],{cwd:e}),yield(0,l.default)("git",["reset","--hard","origin/master","--"],{cwd:e});break;default:throw new Error("Invalid clone target!")}})()}getFpath(){return this.clonePath}getSourceFile(){const t=this.name.split("/")[1],n=[`${t}?(.plugin).?(z)sh`,"*.plugin.zsh","init.zsh","*.zsh","*.sh"];return(0,c.default)(n,{cwd:this.clonePath,nocase:!0})}}const P=new y.default([{title:"Downloading plugins…",task:function(){return new y.default(k.map((t,n)=>{return{title:`Downloading ${t}...`,task:function(){return e(function*(){"string"==typeof k[n]&&(k[n]=new A(t));const e=k[n];yield e.download(),z[n]=e.getSourceFile(),x[n]=e.getFpath()})()}}}),{concurrent:!0})}},{title:`Writing to ${a.default.join(q,"plugins.zsh")}…`,task:function(){return e(function*(){const t=a.default.join(q,"plugins.zsh"),n=z.filter(function(t){return t}).map(function(t){return`source ${t}`}).join("\n"),e=x.filter(function(t){return t}).map(function(t){return`fpath+=${t}`}).join("\n");yield d.default.writeAsync(t,`${n}
${e}`)})()}},{title:"Cleaning up old plugins…",task:function(){return e(function*(){const t=[].concat(n(k.map(function(t){return t.hash})),["plugins.zsh"]),e=d.default.list(q);e&&e.filter(function(n){return!(0,g.default)(t,n)}).forEach(function(t){return d.default.remove(a.default.join(q,t))})})()}}]);P.run();
